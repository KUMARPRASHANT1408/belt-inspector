<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Admin — Reports</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="css/styles.css">
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <header class="topbar">
    <h2>Admin — Reports</h2>
    <div>
      <button id="toDash" class="linkbtn">Dashboard</button>
      <button id="logout">Logout</button>
    </div>
  </header>

  <main class="container">
    <div id="adminMsg" class="muted">Loading... checking admin rights.</div>
    <div id="reportsList"></div>
  </main>

<script>
  const firebaseConfig = /* FIREBASE_CONFIG */ {};
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  auth.onAuthStateChanged(async (user)=>{
    if(!user) { window.location='index.html'; return; }
    // check admins collection by uid
    const adminDoc = await db.collection('admins').doc(user.uid).get();
    if(!adminDoc.exists) {
      document.getElementById('adminMsg').innerText = 'You are not an admin. Contact admin to add you.';
      return;
    }
    document.getElementById('adminMsg').style.display = 'none';
    loadReports();
  });

  async function loadReports() {
    const q = await db.collection('reports').orderBy('created_at','desc').limit(200).get();
    const wrap = document.getElementById('reportsList');
    wrap.innerHTML = '';
    q.forEach(d => {
      const r = d.data();
      const card = document.createElement('div');
      card.className = 'card small';
      const created = r.created_at ? r.created_at.toDate().toLocaleString() : '';
      card.innerHTML = `<strong>${r.conveyor_name || r.conveyor_id} — ${r.department}</strong>
        <p><small>By: ${r.inspector_email} @ ${created}</small></p>
        <pre style="white-space:pre-wrap">${JSON.stringify(r.form_answers||r, null, 2)}</pre>
        <p>Health score: ${r.health_score || 'NA'}</p>
      `;
      // show suggestion button if suggested_master_update present
      if(r.suggested_master_update) {
        const btn = document.createElement('button');
        btn.textContent = 'Approve suggested master update';
        btn.onclick = ()=> approveSuggestion(d.id, r);
        card.appendChild(btn);
        const note = document.createElement('div');
        note.className='muted small';
        note.innerText = 'Suggested update: ' + JSON.stringify(r.suggested_master_update);
        card.appendChild(note);
      }
      wrap.appendChild(card);
    });
  }

  async function approveSuggestion(reportId, report) {
    if(!confirm('Approve suggested master update? This will overwrite selected fields in master conveyor doc.')) return;
    const convId = report.conveyor_id;
    if(!convId) { alert('No conveyor id found on report'); return; }
    try {
      const convRef = db.collection('conveyors').doc(convId);
      await db.runTransaction(async tx => {
        const doc = await tx.get(convRef);
        if(!doc.exists) {
          // create a new master doc
          tx.set(convRef, Object.assign({}, report.conveyor_snapshot || {}, report.suggested_master_update, { last_updated_by: auth.currentUser.email, last_updated_at: firebase.firestore.Timestamp.now() }));
        } else {
          tx.update(convRef, Object.assign({}, report.suggested_master_update, { last_updated_by: auth.currentUser.email, last_updated_at: firebase.firestore.Timestamp.now() }));
        }
      });
      alert('Master conveyor record updated.');
    } catch(err) {
      console.error(err);
      alert('Failed: ' + err.message);
    }
  }

  document.getElementById('logout').addEventListener('click', ()=> firebase.auth().signOut().then(()=> window.location='index.html'));
  document.getElementById('toDash').addEventListener('click', ()=> window.location='dashboard.html');
</script>
</body>
</html>